<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="dashboard-container">
        <nav class="navbar">
            <div class="nav-content">
                <div class="nav-brand">
                    <svg width="40" height="40" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="60" height="60" rx="12" fill="url(#gradient)" />
                        <path d="M30 15L45 25V40L30 50L15 40V25L30 15Z" stroke="white" stroke-width="2" fill="none" />
                        <circle cx="30" cy="30" r="5" fill="white" />
                        <defs>
                            <linearGradient id="gradient" x1="0" y1="0" x2="60" y2="60">
                                <stop offset="0%" stop-color="#667eea" />
                                <stop offset="100%" stop-color="#764ba2" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <span>Employee Portal</span>
                </div>
                <div class="nav-user">
                    <span id="navUsername">Loading...</span>
                    <button onclick="logout()" class="btn-logout">Logout</button>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="profile-header">
                <h1>My Profile</h1>
                <p class="profile-subtitle">View your employee information</p>
            </div>

            <div id="loadingState" class="loading-card">
                <div class="loader-large"></div>
                <p>Loading profile...</p>
            </div>

            <div id="profileContent" style="display: none;">
                <div class="profile-card">
                    <div class="profile-info">
                        <div class="info-row">
                            <div class="info-label">Full Name</div>
                            <div class="info-value" id="fullName">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Username</div>
                            <div class="info-value" id="usernameDisplay">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Email</div>
                            <div class="info-value" id="email">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Department</div>
                            <div class="info-value" id="department">-</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Role</div>
                            <div class="info-value">
                                <span id="role" class="badge">-</span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Employee ID</div>
                            <div class="info-value" id="employeeId">-</div>
                        </div>
                    </div>
                </div>

                <!-- Flag will be displayed here if present -->
                <div id="flagContainer" style="display: none;">
                    <div class="flag-card">
                        <div class="flag-icon">ðŸŽ¯</div>
                        <h2>Special Access Granted</h2>
                        <div class="flag-content">
                            <code id="flagValue"></code>
                        </div>
                    </div>
                </div>
            </div>

            <div id="errorState" class="error-card" style="display: none;">
                <p id="errorText">Failed to load profile</p>
                <button onclick="loadProfile()" class="btn-retry">Retry</button>
            </div>
        </main>
    </div>

    <script>
        // Check if user is logged in
        const userId = localStorage.getItem('userId');
        const username = localStorage.getItem('username');

        if (!userId || !username) {
            window.location.href = '/';
        }

        // Display username in navbar
        document.getElementById('navUsername').textContent = username;

        // Load user profile
        async function loadProfile() {
            const loadingState = document.getElementById('loadingState');
            const profileContent = document.getElementById('profileContent');
            const errorState = document.getElementById('errorState');

            loadingState.style.display = 'flex';
            profileContent.style.display = 'none';
            errorState.style.display = 'none';

            try {
                const response = await fetch(`/api/profile?id=${userId}`);
                const data = await response.json();

                if (response.ok && data.success) {
                    const profile = data.profile;

                    // Populate profile data
                    document.getElementById('fullName').textContent = profile.fullName;
                    document.getElementById('usernameDisplay').textContent = profile.username;
                    document.getElementById('email').textContent = profile.email;
                    document.getElementById('department').textContent = profile.department;
                    document.getElementById('employeeId').textContent = profile.id;

                    const roleBadge = document.getElementById('role');
                    roleBadge.textContent = profile.role;
                    roleBadge.className = 'badge badge-' + profile.role;

                    // Display flag if present
                    if (profile.flag) {
                        document.getElementById('flagValue').textContent = profile.flag;
                        document.getElementById('flagContainer').style.display = 'block';
                    }

                    loadingState.style.display = 'none';
                    profileContent.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Failed to load profile');
                }
            } catch (error) {
                console.error('Profile error:', error);
                document.getElementById('errorText').textContent = error.message;
                loadingState.style.display = 'none';
                errorState.style.display = 'flex';
            }
        }

        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            window.location.href = '/';
        }

        // Load profile on page load
        loadProfile();
    </script>
</body>

</html>